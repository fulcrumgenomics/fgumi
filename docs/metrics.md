# fgumi Metrics Output Reference

This document describes the metrics output files generated by fgumi commands.

## Overview

| Command | Metrics Output | Description |
|---------|---------------|-------------|
| `duplex-metrics` | Multiple files | Comprehensive duplex QC metrics |
| `group` | Optional files | Family size histogram and grouping metrics |

---

## duplex-metrics Output

The `fgumi duplex-metrics` command produces several output files with the specified prefix.

### Usage

```bash
fgumi duplex-metrics \
  --input grouped.bam \
  --output metrics_prefix
```

### Output Files

| File | Description |
|------|-------------|
| `<output>.family_sizes.txt` | Family size distribution by type |
| `<output>.duplex_family_sizes.txt` | Duplex family sizes by strand counts |
| `<output>.duplex_yield_metrics.txt` | Summary QC metrics at subsampling levels |
| `<output>.umi_counts.txt` | UMI observation frequencies |
| `<output>.duplex_umi_counts.txt` | Duplex UMI pair frequencies (optional) |
| `<output>.duplex_qc.pdf` | QC plots (requires R with ggplot2) |

### Terminology

| Prefix | Definition |
|--------|------------|
| **CS** | Coordinate-Strand: families defined by genome coordinates and strand only |
| **SS** | Single-Stranded: families defined by coordinates, strand, and UMI (e.g., 50/A and 50/B are separate) |
| **DS** | Double-Stranded: collapsed across single-stranded families from the same molecule (e.g., 50/A and 50/B become one family) |

---

### family_sizes.txt

Frequency of different family types by size.

| Column | Type | Description |
|--------|------|-------------|
| `family_size` | INT | Number of reads in the family |
| `cs_families` | INT | Count of CS families with this size |
| `ss_families` | INT | Count of SS families with this size |
| `ds_families` | INT | Count of DS families with this size |
| `ss_from_cs_families` | INT | SS families derived from CS families |
| `ds_from_ss_families` | INT | DS families derived from SS families |

**Example:**
```
family_size	cs_families	ss_families	ds_families	ss_from_cs_families	ds_from_ss_families
1	5420	5420	3210	5420	3210
2	3150	3150	1890	3150	1890
3	1820	1820	1092	1820	1092
```

---

### duplex_family_sizes.txt

Distribution of duplex families by the number of reads from each strand.

| Column | Type | Description |
|--------|------|-------------|
| `ab_size` | INT | Number of A→B strand reads |
| `ba_size` | INT | Number of B→A strand reads |
| `count` | INT | Number of duplex families with this configuration |

**Example:**
```
ab_size	ba_size	count
1	1	542
1	2	318
2	1	295
2	2	1024
3	3	892
```

---

### duplex_yield_metrics.txt

Summary metrics calculated at different subsampling fractions (5%, 10%, 15%...100%) for yield curve analysis.

| Column | Type | Description |
|--------|------|-------------|
| `fraction` | FLOAT | Fraction of data used (0.05 to 1.0) |
| `read_pairs` | INT | Total read pairs at this fraction |
| `cs_families` | INT | Number of CS families |
| `ss_families` | INT | Number of SS families |
| `ds_families` | INT | Number of DS families |
| `ds_duplexes` | INT | Number of true duplexes (both strands present) |
| `ds_duplex_fraction` | FLOAT | Fraction of DS families that are duplexes |
| `mean_ss_family_size` | FLOAT | Mean single-stranded family size |
| `mean_ds_family_size` | FLOAT | Mean double-stranded family size |

**Example:**
```
fraction	read_pairs	cs_families	ss_families	ds_families	ds_duplexes	ds_duplex_fraction	mean_ss_family_size	mean_ds_family_size
0.05	5000	2100	2100	1260	840	0.667	2.38	3.97
0.10	10000	3800	3800	2280	1520	0.667	2.63	4.39
...
1.00	100000	25600	25600	15360	10240	0.667	3.91	6.51
```

---

### umi_counts.txt

Frequency distribution of UMI observations.

| Column | Type | Description |
|--------|------|-------------|
| `umi_observations` | INT | Number of times a UMI was observed |
| `umi_count` | INT | Number of unique UMIs with this observation count |
| `read_count` | INT | Total reads contributing to this bin |

**Example:**
```
umi_observations	umi_count	read_count
1	8542	8542
2	3210	6420
3	1892	5676
4	945	3780
```

---

### duplex_umi_counts.txt

Frequency distribution of duplex UMI pair observations. Only generated with `--duplex-umi-counts` flag.

| Column | Type | Description |
|--------|------|-------------|
| `umi_pair_observations` | INT | Number of times a UMI pair was observed |
| `umi_pair_count` | INT | Number of unique UMI pairs with this count |
| `read_count` | INT | Total reads contributing to this bin |

**Note:** This file requires significantly more memory to generate when many unique UMI sequences are present.

---

### duplex_qc.pdf

A multi-page PDF containing visualization plots:

1. **Family Size Distribution**: Histogram of SS and DS family sizes
2. **Duplex Yield Curve**: DS duplex fraction vs. subsampling fraction
3. **Strand Balance**: Heatmap of AB vs BA strand counts
4. **UMI Observation Distribution**: Histogram of UMI observation frequencies

**Requirements:** R with `ggplot2` and `scales` packages installed.

Use `--description` to add a sample name to plot titles:
```bash
fgumi duplex-metrics --input sample.bam --output sample --description "Sample A"
```

---

## group Output

The `fgumi group` command can optionally output metrics files.

### Usage

```bash
fgumi group \
  --input aligned.bam \
  --output grouped.bam \
  --strategy adjacency \
  --family-size-histogram family_sizes.txt \
  --grouping-metrics grouping.txt
```

---

### family_sizes.txt (--family-size-histogram)

Distribution of UMI family sizes.

| Column | Type | Description |
|--------|------|-------------|
| `family_size` | INT | Number of reads in the family |
| `count` | INT | Number of families with this size |

**Example:**
```
family_size	count
1	12458
2	8921
3	5432
4	3210
5	1892
```

This file can be used as input to `fgumi simulate` commands with `--family-size-dist` to simulate realistic family size distributions.

---

### grouping_metrics.txt (--grouping-metrics)

Summary statistics about the grouping process.

| Metric | Type | Description |
|--------|------|-------------|
| `total_templates` | INT | Total read templates processed |
| `assigned_templates` | INT | Templates assigned to a UMI group |
| `filtered_templates` | INT | Templates filtered out |
| `unique_positions` | INT | Unique genomic positions with reads |
| `total_families` | INT | Total UMI families created |
| `mean_family_size` | FLOAT | Mean reads per family |
| `median_family_size` | INT | Median reads per family |
| `max_family_size` | INT | Maximum family size |
| `singletons` | INT | Families with single read |
| `singleton_fraction` | FLOAT | Fraction of families that are singletons |

---

## File Format Notes

### General Format

All metrics files are tab-separated values (TSV) with:
- Header row with column names
- One data row per record
- UTF-8 encoding

### Reading in Python

```python
import pandas as pd

# Read family sizes
family_sizes = pd.read_csv("metrics.family_sizes.txt", sep="\t")

# Read yield metrics
yield_metrics = pd.read_csv("metrics.duplex_yield_metrics.txt", sep="\t")
```

### Reading in R

```r
# Read family sizes
family_sizes <- read.table("metrics.family_sizes.txt", header=TRUE, sep="\t")

# Read yield metrics
yield_metrics <- read.table("metrics.duplex_yield_metrics.txt", header=TRUE, sep="\t")
```

---

## Comparing Metrics

Use `fgumi compare metrics` to compare metrics files between runs or implementations:

```bash
# Compare with default precision
fgumi compare metrics fgumi_metrics.txt fgbio_metrics.txt

# Compare with tolerance for floating-point differences
fgumi compare metrics file1.txt file2.txt --precision 6 --rel-tol 1e-6
```

See [compare-cli.md](compare-cli.md) for full documentation.
