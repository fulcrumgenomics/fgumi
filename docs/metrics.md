# fgumi Metrics Output Reference

This document describes the metrics output files generated by fgumi commands.

## Overview

| Command | Metrics Output | Description |
|---------|---------------|-------------|
| `filter` | Optional file | Filtering pass/fail statistics |
| `simplex` | Optional file | Consensus calling statistics |
| `duplex` | Optional file | Consensus calling statistics |
| `codec` | Optional file | Consensus calling statistics |
| `dedup` | Optional files | Deduplication metrics and family size histogram |
| `duplex-metrics` | Multiple files | Comprehensive duplex QC metrics |
| `group` | Optional files | Family size histogram and grouping metrics |

---

## filter Output

The `fgumi filter` command can optionally output filtering statistics.

### Usage

```bash
fgumi filter \
  --input consensus.bam \
  --output filtered.bam \
  --stats filter_stats.txt
```

### filter_stats.txt (--stats)

Filtering pass/fail statistics in two-column key-value format (no header row).

| Key | Value Type | Description |
|-----|-----------|-------------|
| `total_reads` | INT | Total number of reads processed |
| `passed_reads` | INT | Number of reads that passed filtering |
| `failed_reads` | INT | Number of reads that failed filtering |
| `pass_rate` | FLOAT | Fraction of reads that passed (4 decimal places) |

**Example:**
```text
total_reads	10000
passed_reads	8542
failed_reads	1458
pass_rate	0.8542
```

---

## simplex / duplex Output

The `fgumi simplex` and `fgumi duplex` commands can optionally output consensus calling statistics.

### Usage

```bash
fgumi simplex \
  --input grouped.bam \
  --output consensus.bam \
  --stats simplex_stats.txt

fgumi duplex \
  --input grouped.bam \
  --output consensus.bam \
  --stats duplex_stats.txt
```

### stats.txt (--stats)

Consensus calling statistics in three-column key-value-description format (vertical layout, one metric per row). This format is compatible with fgbio's `CallMolecularConsensusReads` output.

| Column | Type | Description |
|--------|------|-------------|
| `key` | STRING | Metric name |
| `value` | STRING | Metric value (integer or float) |
| `description` | STRING | Human-readable description |

**Always-present metrics (in order):**

| Key | Value Type | Description |
|-----|-----------|-------------|
| `raw_reads_considered` | INT | Total raw reads considered from input file |
| `raw_reads_rejected` | INT | Total number of raw reads rejected before consensus calling |
| `raw_reads_used` | INT | Total count of raw reads used in consensus reads |
| `frac_raw_reads_used` | FLOAT | Fraction of raw reads used in consensus reads (6 decimal places) |
| `raw_reads_rejected_for_insufficient_support` | INT | Insufficient reads to generate a consensus |
| `raw_reads_rejected_for_minority_alignment` | INT | Read has a different, and minority, set of indels |
| `raw_reads_rejected_for_orphan_consensus` | INT | Only one of R1 or R2 consensus generated |
| `raw_reads_rejected_for_zero_bases_post_trimming` | INT | Read or mate had zero bases post trimming |
| `consensus_reads_emitted` | INT | Total number of consensus reads (R1+R2=2) emitted |

**Conditional metrics (only present when count > 0):**

| Key | Description |
|-----|-------------|
| `raw_reads_rejected_for_insufficient_strand_support` | Insufficient strand support for consensus |
| `raw_reads_rejected_for_low_base_quality` | Low base quality |
| `raw_reads_rejected_for_excessive_n_bases` | Excessive N bases in read |
| `raw_reads_rejected_for_no_valid_alignment` | No valid alignment found |
| `raw_reads_rejected_for_low_mapping_quality` | Low mapping quality |
| `raw_reads_rejected_for_n_bases_in_umi` | N bases in UMI sequence |
| `raw_reads_rejected_for_missing_umi` | Read lacks required UMI tag |
| `raw_reads_rejected_for_not_passing_filter` | Read did not pass vendor filter |
| `raw_reads_rejected_for_low_mean_quality` | Low mean base quality |
| `raw_reads_rejected_for_insufficient_min_depth` | Insufficient minimum read depth |
| `raw_reads_rejected_for_excessive_error_rate` | Excessive error rate |
| `raw_reads_rejected_for_umi_too_short` | UMI sequence too short |
| `raw_reads_rejected_for_single_strand_only` | Only generating one strand of duplex consensus |
| `raw_reads_rejected_for_duplicate_umi` | Duplicate UMI detected |

**Example:**
```text
key	value	description
raw_reads_considered	50000	Total raw reads considered from input file
raw_reads_rejected	8200	Total number of raw reads rejected before consensus calling
raw_reads_used	41800	Total count of raw reads used in consensus reads
frac_raw_reads_used	0.836000	Fraction of raw reads used in consensus reads
raw_reads_rejected_for_insufficient_support	5100	Insufficient reads to generate a consensus
raw_reads_rejected_for_minority_alignment	1200	Read has a different, and minority, set of indels
raw_reads_rejected_for_orphan_consensus	1400	Only one of R1 or R2 consensus generated
raw_reads_rejected_for_zero_bases_post_trimming	500	Read or mate had zero bases post trimming
consensus_reads_emitted	12000	Total number of consensus reads (R1+R2=2) emitted.
```

---

## codec Output

The `fgumi codec` command can optionally output consensus calling statistics.

### Usage

```bash
fgumi codec \
  --input grouped.bam \
  --output consensus.bam \
  --stats codec_stats.txt
```

### stats.txt (--stats)

Consensus calling statistics in horizontal single-row TSV format with a header row. All `ConsensusMetrics` fields are output as columns.

| Column | Type | Description |
|--------|------|-------------|
| `total_input_reads` | INT | Total input reads processed |
| `consensus_reads` | INT | Number of consensus reads generated |
| `filtered_reads` | INT | Number of input reads filtered out |
| `total_umi_groups` | INT | Total number of UMI groups processed |
| `umi_groups_with_consensus` | INT | UMI groups that generated consensus |
| `umi_groups_failed` | INT | UMI groups that failed to generate consensus |
| `avg_input_reads_per_consensus` | FLOAT | Average input reads per consensus read |
| `avg_raw_read_depth` | FLOAT | Average raw read depth per consensus read |
| `min_raw_read_depth` | INT | Minimum raw read depth |
| `max_raw_read_depth` | INT | Maximum raw read depth |
| `rejected_insufficient_support` | INT | Reads rejected: insufficient support |
| `rejected_minority_alignment` | INT | Reads rejected: minority alignment |
| `rejected_insufficient_strand_support` | INT | Reads rejected: insufficient strand support |
| `rejected_low_base_quality` | INT | Reads rejected: low base quality |
| `rejected_excessive_n_bases` | INT | Reads rejected: excessive N bases |
| `rejected_no_valid_alignment` | INT | Reads rejected: no valid alignment |
| `rejected_low_mapping_quality` | INT | Reads rejected: low mapping quality |
| `rejected_n_bases_in_umi` | INT | Reads rejected: N bases in UMI |
| `rejected_missing_umi` | INT | Reads rejected: missing UMI tag |
| `rejected_not_passing_filter` | INT | Reads rejected: not passing vendor filter |
| `rejected_low_mean_quality` | INT | Reads rejected: low mean quality |
| `rejected_insufficient_min_depth` | INT | Reads rejected: insufficient min depth |
| `rejected_excessive_error_rate` | INT | Reads rejected: excessive error rate |
| `rejected_umi_too_short` | INT | Reads rejected: UMI too short |
| `rejected_same_strand_only` | INT | Reads rejected: same strand only |
| `rejected_duplicate_umi` | INT | Reads rejected: duplicate UMI |
| `rejected_orphan_consensus` | INT | Reads rejected: orphan consensus |
| `rejected_zero_bases_post_trimming` | INT | Reads rejected: zero bases post trimming |

**Example:**
```text
total_input_reads	consensus_reads	filtered_reads	total_umi_groups	...
50000	12000	8200	15000	...
```

---

## dedup Output

The `fgumi dedup` command can optionally output deduplication metrics and a family size histogram.

### Usage

```bash
fgumi dedup \
  --input grouped.bam \
  --output deduped.bam \
  --metrics dedup_metrics.txt \
  --family-size-histogram family_sizes.txt
```

### dedup_metrics.txt (--metrics / -m)

Deduplication summary in horizontal single-row TSV format with a header row.

| Column | Type | Description |
|--------|------|-------------|
| `total_templates` | INT | Total templates processed |
| `unique_templates` | INT | Templates kept (not duplicates) |
| `duplicate_templates` | INT | Templates marked as duplicates |
| `duplicate_rate` | FLOAT | Fraction of templates that are duplicates |
| `total_reads` | INT | Total reads processed |
| `unique_reads` | INT | Unique reads (not duplicates) |
| `duplicate_reads` | INT | Reads marked as duplicates |
| `secondary_reads` | INT | Secondary reads processed |
| `supplementary_reads` | INT | Supplementary reads processed |
| `missing_pa_tag` | INT | Secondary/supplementary reads without pa tag |

**Example:**
```text
total_templates	unique_templates	duplicate_templates	duplicate_rate	total_reads	unique_reads	duplicate_reads	secondary_reads	supplementary_reads	missing_pa_tag
25000	18750	6250	0.25	50000	37500	12500	0	0	0
```

---

### family_sizes.txt (--family-size-histogram / -H)

Distribution of UMI family sizes with cumulative fractions.

| Column | Type | Description |
|--------|------|-------------|
| `family_size` | INT | Number of reads in the family |
| `count` | INT | Number of families with this size |
| `fraction` | FLOAT | Fraction of all families with this size |
| `fraction_gt_or_eq_family_size` | FLOAT | Cumulative fraction of families with size >= this value |

**Example:**
```text
family_size	count	fraction	fraction_gt_or_eq_family_size
1	12458	0.394	1.000
2	8921	0.282	0.606
3	5432	0.172	0.324
4	3210	0.102	0.152
5	1580	0.050	0.050
```

---

## duplex-metrics Output

The `fgumi duplex-metrics` command produces several output files with the specified prefix.

### Usage

```bash
fgumi duplex-metrics \
  --input grouped.bam \
  --output metrics_prefix
```

### Output Files

| File | Description |
|------|-------------|
| `<output>.family_sizes.txt` | Family size distribution by type |
| `<output>.duplex_family_sizes.txt` | Duplex family sizes by strand counts |
| `<output>.duplex_yield_metrics.txt` | Summary QC metrics at subsampling levels |
| `<output>.umi_counts.txt` | UMI observation frequencies |
| `<output>.duplex_umi_counts.txt` | Duplex UMI pair frequencies (optional) |
| `<output>.duplex_qc.pdf` | QC plots (requires R with ggplot2) |

### Terminology

| Prefix | Definition |
|--------|------------|
| **CS** | Coordinate-Strand: families defined by genome coordinates and strand only |
| **SS** | Single-Stranded: families defined by coordinates, strand, and UMI (e.g., 50/A and 50/B are separate) |
| **DS** | Double-Stranded: collapsed across single-stranded families from the same molecule (e.g., 50/A and 50/B become one family) |

---

### family_sizes.txt

Frequency of different family types by size.

| Column | Type | Description |
|--------|------|-------------|
| `family_size` | INT | Number of reads in the family |
| `cs_families` | INT | Count of CS families with this size |
| `ss_families` | INT | Count of SS families with this size |
| `ds_families` | INT | Count of DS families with this size |
| `ss_from_cs_families` | INT | SS families derived from CS families |
| `ds_from_ss_families` | INT | DS families derived from SS families |

**Example:**
```text
family_size	cs_families	ss_families	ds_families	ss_from_cs_families	ds_from_ss_families
1	5420	5420	3210	5420	3210
2	3150	3150	1890	3150	1890
3	1820	1820	1092	1820	1092
```

---

### duplex_family_sizes.txt

Distribution of duplex families by the number of reads from each strand.

| Column | Type | Description |
|--------|------|-------------|
| `ab_size` | INT | Number of A→B strand reads |
| `ba_size` | INT | Number of B→A strand reads |
| `count` | INT | Number of duplex families with this configuration |

**Example:**
```text
ab_size	ba_size	count
1	1	542
1	2	318
2	1	295
2	2	1024
3	3	892
```

---

### duplex_yield_metrics.txt

Summary metrics calculated at different subsampling fractions (5%, 10%, 15%...100%) for yield curve analysis.

| Column | Type | Description |
|--------|------|-------------|
| `fraction` | FLOAT | Fraction of data used (0.05 to 1.0) |
| `read_pairs` | INT | Total read pairs at this fraction |
| `cs_families` | INT | Number of CS families |
| `ss_families` | INT | Number of SS families |
| `ds_families` | INT | Number of DS families |
| `ds_duplexes` | INT | Number of true duplexes (both strands present) |
| `ds_duplex_fraction` | FLOAT | Fraction of DS families that are duplexes |
| `mean_ss_family_size` | FLOAT | Mean single-stranded family size |
| `mean_ds_family_size` | FLOAT | Mean double-stranded family size |

**Example:**
```text
fraction	read_pairs	cs_families	ss_families	ds_families	ds_duplexes	ds_duplex_fraction	mean_ss_family_size	mean_ds_family_size
0.05	5000	2100	2100	1260	840	0.667	2.38	3.97
0.10	10000	3800	3800	2280	1520	0.667	2.63	4.39
...
1.00	100000	25600	25600	15360	10240	0.667	3.91	6.51
```

---

### umi_counts.txt

Frequency distribution of UMI observations.

| Column | Type | Description |
|--------|------|-------------|
| `umi_observations` | INT | Number of times a UMI was observed |
| `umi_count` | INT | Number of unique UMIs with this observation count |
| `read_count` | INT | Total reads contributing to this bin |

**Example:**
```text
umi_observations	umi_count	read_count
1	8542	8542
2	3210	6420
3	1892	5676
4	945	3780
```

---

### duplex_umi_counts.txt

Frequency distribution of duplex UMI pair observations. Only generated with `--duplex-umi-counts` flag.

| Column | Type | Description |
|--------|------|-------------|
| `umi_pair_observations` | INT | Number of times a UMI pair was observed |
| `umi_pair_count` | INT | Number of unique UMI pairs with this count |
| `read_count` | INT | Total reads contributing to this bin |

**Note:** This file requires significantly more memory to generate when many unique UMI sequences are present.

---

### duplex_qc.pdf

A multi-page PDF containing visualization plots:

1. **Family Size Distribution**: Histogram of SS and DS family sizes
2. **Duplex Yield Curve**: DS duplex fraction vs. subsampling fraction
3. **Strand Balance**: Heatmap of AB vs BA strand counts
4. **UMI Observation Distribution**: Histogram of UMI observation frequencies

**Requirements:** R with `ggplot2` and `scales` packages installed.

Use `--description` to add a sample name to plot titles:
```bash
fgumi duplex-metrics --input sample.bam --output sample --description "Sample A"
```

---

## group Output

The `fgumi group` command can optionally output metrics files.

### Usage

```bash
fgumi group \
  --input aligned.bam \
  --output grouped.bam \
  --strategy adjacency \
  --family-size-histogram family_sizes.txt \
  --grouping-metrics grouping.txt
```

---

### family_sizes.txt (--family-size-histogram)

Distribution of UMI family sizes.

| Column | Type | Description |
|--------|------|-------------|
| `family_size` | INT | Number of reads in the family |
| `count` | INT | Number of families with this size |
| `fraction` | FLOAT | Fraction of all families with this size |
| `fraction_gt_or_eq_family_size` | FLOAT | Fraction of families with size >= this size |

**Example:**
```text
family_size	count	fraction	fraction_gt_or_eq_family_size
1	12458	0.3901	1.0000
2	8921	0.2793	0.6099
3	5432	0.1701	0.3306
4	3210	0.1005	0.1605
5	1892	0.0592	0.0600
```

This file can be used as input to `fgumi simulate` commands with `--family-size-dist` to simulate realistic family size distributions.

---

### grouping_metrics.txt (--grouping-metrics)

Summary statistics about the grouping process.

| Metric | Type | Description |
|--------|------|-------------|
| `total_records` | INT | Total SAM records processed |
| `accepted_records` | INT | Records accepted for grouping |
| `discarded_non_pf` | INT | Records discarded (not passing filter) |
| `discarded_poor_alignment` | INT | Records discarded (poor alignment quality) |
| `discarded_ns_in_umi` | INT | Records discarded (Ns in UMI) |
| `discarded_umi_too_short` | INT | Records discarded (UMI too short) |
| `unique_molecule_ids` | INT | Number of unique molecule IDs assigned |
| `total_families` | INT | Total number of UMI families/groups |
| `avg_reads_per_molecule` | FLOAT | Average reads per molecule |
| `median_reads_per_molecule` | INT | Median reads per molecule |
| `min_reads_per_molecule` | INT | Minimum reads per molecule |
| `max_reads_per_molecule` | INT | Maximum reads per molecule |

---

## File Format Notes

### General Format

Most metrics files are tab-separated values (TSV) with:
- Header row with column names
- One data row per record
- UTF-8 encoding

**Exceptions:**
- `filter --stats` uses a two-column key-value format without a header row.
- `simplex --stats` and `duplex --stats` use a three-column vertical key-value-description format (one metric per row, with a header row).

### Reading in Python

```python
import pandas as pd

# Read horizontal TSV (dedup, codec, duplex-metrics, group)
dedup_metrics = pd.read_csv("dedup_metrics.txt", sep="\t")

# Read vertical KV format (simplex, duplex)
consensus_stats = pd.read_csv("simplex_stats.txt", sep="\t")
# Access metrics by key:
# consensus_stats[consensus_stats["key"] == "consensus_reads_emitted"]["value"]

# Read filter stats (no header)
filter_stats = pd.read_csv("filter_stats.txt", sep="\t", header=None, names=["key", "value"])
```

### Reading in R

```r
# Read horizontal TSV
dedup_metrics <- read.table("dedup_metrics.txt", header=TRUE, sep="\t")

# Read vertical KV format
consensus_stats <- read.table("simplex_stats.txt", header=TRUE, sep="\t")

# Read filter stats (no header)
filter_stats <- read.table("filter_stats.txt", header=FALSE, sep="\t", col.names=c("key", "value"))
```

---

## Comparing Metrics

Use `fgumi compare metrics` to compare metrics files between runs or implementations:

```bash
# Compare with default precision
fgumi compare metrics fgumi_metrics.txt fgbio_metrics.txt

# Compare with tolerance for floating-point differences
fgumi compare metrics file1.txt file2.txt --precision 6 --rel-tol 1e-6
```

See [compare-cli.md](compare-cli.md) for full documentation.
